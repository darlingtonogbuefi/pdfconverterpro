# Deploy Backend & Worker to EC2 using SSH jump (bastion)
# .github/workflows/deploy-backend.yml

name: Deploy Backend & Worker to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Install backend dependencies locally (needed for venv)
      - name: Install backend dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      # Debug SSH host for backend
      - name: Debug SSH host (Backend)
        run: |
          echo "SSH action trying to connect to backend host (private IP): ${{ secrets.API_HOST }}"
          echo "Through bastion host: ${{ secrets.BASTION_HOST }}"

      # Deploy backend via SSH jump using temporary key file
      - name: Deploy backend via SSH
        run: |
          # Write PEM key to temporary file
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

          # SSH into backend via bastion
          ssh -o StrictHostKeyChecking=no \
              -i ec2_key.pem \
              -J ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} \
              ${{ secrets.EC2_USER }}@${{ secrets.API_HOST }} << 'EOF'
                cd ~/pdfconverterpro
                git pull origin main
                source venv/bin/activate
                pip install -r requirements.txt
                # restart backend service
                sudo systemctl restart pdfconvertpro-api || nohup uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
          EOF

          # Clean up temporary key file
          rm -f ec2_key.pem

      # Debug SSH host for worker
      - name: Debug SSH host (Worker)
        run: |
          echo "SSH action trying to connect to worker host (private IP): ${{ secrets.WORKER_HOST }}"
          echo "Through bastion host: ${{ secrets.BASTION_HOST }}"

      # Deploy worker via SSH jump using temporary key file
      - name: Deploy worker via SSH
        run: |
          # Write PEM key to temporary file
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

          # SSH into worker via bastion
          ssh -o StrictHostKeyChecking=no \
              -i ec2_key.pem \
              -J ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} \
              ${{ secrets.EC2_USER }}@${{ secrets.WORKER_HOST }} << 'EOF'
                cd ~/pdfconverterpro
                git pull origin main
                source venv/bin/activate
                pip install -r requirements.txt
                # restart worker service
                sudo systemctl restart pdfconvertpro-worker || nohup python backend/worker.py &
          EOF

          # Clean up temporary key file
          rm -f ec2_key.pem
